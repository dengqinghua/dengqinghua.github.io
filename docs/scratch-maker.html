<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>maker of application</title>

  <!-- Begin Jekyll SEO tag v2.6.1 -->
<meta name="generator" content="Jekyll v3.8.7" />
<meta property="og:title" content="maker of application" />
<meta name="author" content="dengqinghua" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="运维 机器配置 4核8G" />
<meta property="og:description" content="运维 机器配置 4核8G" />
<link rel="canonical" href="https://dengqinghua.github.io/scratch-maker.html" />
<meta property="og:url" content="https://dengqinghua.github.io/scratch-maker.html" />
<meta property="og:site_name" content="Dengqinghua.42" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-04-23T00:00:00+08:00" />
<script type="application/ld+json">
{"dateModified":"2021-04-23T00:00:00+08:00","datePublished":"2021-04-23T00:00:00+08:00","url":"https://dengqinghua.github.io/scratch-maker.html","author":{"@type":"Person","name":"dengqinghua"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://dengqinghua.github.io/scratch-maker.html"},"@type":"BlogPosting","description":"运维 机器配置 4核8G","headline":"maker of application","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

  <link type="application/atom+xml" rel="alternate" href="https://dengqinghua.github.io/feed.xml" title="Dengqinghua.42" />

  <link rel="shortcut icon" type="image/x-icon" href="/logo.png" />
  <link rel="stylesheet" href="/assets/css/main.css" />
  <link rel="stylesheet" href="/assets/css/zoom.css" />
  <link rel="stylesheet" href="/assets/css/gitalk.css" />
  <link rel="stylesheet" href="/assets/css/syntax.css" />
  <script src="assets/js/mermaid.min.js"></script>
  <script src="assets/js/jquery.min.js"></script>
  <script src="assets/js/zoom.min.js"></script>
  <script src="assets/js/zoom_init.js"></script>
  <script src="assets/js/mermaid_config.js"></script>
  <script src="assets/js/gitalk.min.js"></script>
  <script src="assets/js/gitalk_init.js"></script>
  <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  <script src="assets/js/mathjax_init.js"></script>
</head>
<body a="light">
    <main class="page-content" aria-label="Content">
      <div class="w">
        <a href="/">..</a>

<article>
  <p class="post-meta">
    <time datetime="2021-04-23 00:00:00 +0800">2021-04-23</time>
  </p>
  
  <h1>maker of application</h1>

  <ul id="toc" class="section-nav">
<li class="toc-entry toc-h3">
<a href="#%E8%BF%90%E7%BB%B4">运维</a>
<ul>
<li class="toc-entry toc-h4"><a href="#%E6%9C%BA%E5%99%A8%E9%85%8D%E7%BD%AE">机器配置</a></li>
<li class="toc-entry toc-h4"><a href="#%E7%94%A8%E6%88%B7%E9%85%8D%E7%BD%AE">用户配置</a></li>
<li class="toc-entry toc-h4"><a href="#%E8%BD%AF%E4%BB%B6%E5%AE%89%E8%A3%85">软件安装</a></li>
</ul>
</li>
<li class="toc-entry toc-h3">
<a href="#%E5%9F%BA%E7%A1%80%E8%AE%BE%E6%96%BD">基础设施</a>
<ul>
<li class="toc-entry toc-h4"><a href="#gitlab">gitlab</a></li>
<li class="toc-entry toc-h4"><a href="#%E5%85%B6%E4%BB%96">其他</a></li>
</ul>
</li>
<li class="toc-entry toc-h3"><a href="#%E4%B8%AD%E9%97%B4%E4%BB%B6">中间件</a></li>
<li class="toc-entry toc-h3"><a href="#%E4%B8%9A%E5%8A%A1%E7%B3%BB%E7%BB%9F">业务系统</a></li>
<li class="toc-entry toc-h3"><a href="#%E6%90%AD%E5%BB%BA%E7%B3%BB%E7%BB%9F%E8%B7%AF%E7%BA%BF">搭建系统路线</a></li>
</ul>
<h3 id="运维">
<a class="anchor" href="#%E8%BF%90%E7%BB%B4" aria-hidden="true"><span class="octicon octicon-link"></span></a>运维</h3>
<h4 id="机器配置">
<a class="anchor" href="#%E6%9C%BA%E5%99%A8%E9%85%8D%E7%BD%AE" aria-hidden="true"><span class="octicon octicon-link"></span></a>机器配置</h4>
<p>4核8G</p>

<h4 id="用户配置">
<a class="anchor" href="#%E7%94%A8%E6%88%B7%E9%85%8D%E7%BD%AE" aria-hidden="true"><span class="octicon octicon-link"></span></a>用户配置</h4>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>su -
useradd YouName
passwd YouName
visudo
YouName <span class="nv">ALL</span><span class="o">=(</span>ALL<span class="o">)</span> NOPASSWD:ALL

<span class="c"># 设置通用的目录</span>
<span class="nb">mkdir</span> <span class="nt">-p</span> /var/www/site
<span class="nb">chmod</span> <span class="nt">-R</span> 777 /var/www/site
</code></pre></div></div>

<h4 id="软件安装">
<a class="anchor" href="#%E8%BD%AF%E4%BB%B6%E5%AE%89%E8%A3%85" aria-hidden="true"><span class="octicon octicon-link"></span></a>软件安装</h4>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>yum <span class="nb">install</span> <span class="nt">-y</span> git nginx ruby jq
</code></pre></div></div>

<p>需要将 docker, nginx, filebeat 加入到自启动项目中</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>systemctl <span class="nb">enable </span>docker.service
<span class="nb">sudo </span>systemctl <span class="nb">enable </span>nginx.service
<span class="nb">sudo </span>systemctl <span class="nb">enable </span>filebeat.service
</code></pre></div></div>

<ul>
  <li><a href="https://docs.docker.com/engine/install/centos/" target="_blank" rel="noopener noreferrer">docker</a></li>
  <li>
    <p><a href="https://docs.gitlab.com/runner/install/linux-repository.html" target="_blank" rel="noopener noreferrer">gitlab-runner</a></p>

    <p>需要将 runner 加入到 root, docker 中，并设置 gitlab-runner 的基本 cp, nginx 等权限</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>  <span class="nb">sudo </span>usermod <span class="nt">-aG</span> root gitlab-runner
  <span class="nb">sudo </span>usermod <span class="nt">-aG</span> docker gitlab-runner
  <span class="nb">sudo </span>visudo
  gitlab-runner <span class="nv">ALL</span><span class="o">=(</span>ALL<span class="o">)</span> NOPASSWD: /usr/sbin/nginx, /usr/bin/cp
</code></pre></div>    </div>
  </li>
  <li>node
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>  curl <span class="nt">-sL</span> https://rpm.nodesource.com/setup_12.x | <span class="nb">sudo </span>bash <span class="nt">-lu</span>
  <span class="nb">sudo </span>yum <span class="nb">install</span> <span class="nt">-y</span> nodejs
</code></pre></div>    </div>
  </li>
  <li>nginx
    <details>
      <summary>
  NGINX 的一些配置参考
  </summary>
      <p>静态文件</p>

      <div class="language-nginx highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>  <span class="k">server</span> <span class="p">{</span>
      <span class="kn">listen</span> <span class="mi">80</span><span class="p">;</span>

      <span class="kn">proxy_set_header</span> <span class="s">X-Real-IP</span> <span class="nv">$remote_addr</span><span class="p">;</span>
      <span class="kn">proxy_set_header</span> <span class="s">Host</span> <span class="nv">$host</span><span class="p">;</span>

      <span class="kn">server_name</span> <span class="s">admin.exmaple.com</span><span class="p">;</span>

      <span class="kn">client_max_body_size</span> <span class="mi">200M</span><span class="p">;</span>

      <span class="kn">root</span> <span class="n">/var/www/site/admin_dev</span><span class="p">;</span>
      <span class="kn">location</span> <span class="n">/</span> <span class="p">{</span>
        <span class="kn">index</span> <span class="s">index.html</span> <span class="s">index.htm</span><span class="p">;</span>
        <span class="kn">try_files</span> <span class="nv">$uri</span> <span class="n">/index.html</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="kn">gzip</span> <span class="no">on</span><span class="p">;</span>
      <span class="kn">gzip_buffers</span> <span class="mi">32</span> <span class="mi">4K</span><span class="p">;</span>
      <span class="kn">gzip_comp_level</span> <span class="mi">6</span><span class="p">;</span>
      <span class="kn">gzip_min_length</span> <span class="mi">100</span><span class="p">;</span>
      <span class="kn">gzip_types</span> <span class="nc">application/javascript</span> <span class="nc">text/css</span> <span class="nc">text/xml</span><span class="p">;</span>
      <span class="kn">gzip_disable</span> <span class="s">"MSIE</span> <span class="s">[1-6]</span><span class="err">\</span><span class="s">."</span><span class="p">;</span>
      <span class="kn">gzip_vary</span> <span class="no">on</span><span class="p">;</span>
  <span class="p">}</span>
</code></pre></div>      </div>

      <p>SSL</p>

      <div class="language-nginx highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>  <span class="k">server</span> <span class="p">{</span>
      <span class="kn">listen</span> <span class="mi">443</span> <span class="s">ssl</span><span class="p">;</span>

      <span class="kn">server_name</span> <span class="s">api0.exmaple.com</span><span class="p">;</span>
      <span class="c1">## 这个文件需要放在 /etc/nginx 的目录下</span>
      <span class="kn">ssl_certificate</span> <span class="s">1_api0.exmaple.com_bundle.crt</span><span class="p">;</span>
      <span class="kn">ssl_certificate_key</span> <span class="s">2_api0.exmaple.com.key</span><span class="p">;</span>
      <span class="kn">ssl_session_timeout</span> <span class="mi">5m</span><span class="p">;</span>
      <span class="kn">ssl_protocols</span> <span class="s">TLSv1</span> <span class="s">TLSv1.1</span> <span class="s">TLSv1.2</span><span class="p">;</span>
      <span class="kn">ssl_ciphers</span> <span class="s">ECDHE-RSA-AES128-GCM-SHA256:HIGH:!aNULL:!MD5:!RC4:!DHE</span><span class="p">;</span>
      <span class="kn">ssl_prefer_server_ciphers</span> <span class="no">on</span><span class="p">;</span>

      <span class="kn">proxy_set_header</span> <span class="s">X-Real-IP</span> <span class="nv">$remote_addr</span><span class="p">;</span>
      <span class="kn">proxy_set_header</span> <span class="s">Host</span> <span class="nv">$host</span><span class="p">;</span>

      <span class="kn">client_max_body_size</span> <span class="mi">100M</span><span class="p">;</span>

      <span class="kn">location</span> <span class="n">/</span> <span class="p">{</span>
        <span class="kn">proxy_pass</span> <span class="s">http://127.0.0.1:8888</span><span class="p">;</span>
      <span class="p">}</span>
  <span class="p">}</span>
</code></pre></div>      </div>

      <p>负载均衡</p>

      <div class="language-nginx highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>  <span class="k">upstream</span> <span class="s">java_prod_server</span> <span class="p">{</span>
    <span class="kn">server</span> <span class="nf">127.0.0.1</span><span class="p">:</span><span class="mi">8880</span><span class="p">;</span>
    <span class="kn">server</span> <span class="nf">127.0.0.1</span><span class="p">:</span><span class="mi">8881</span><span class="p">;</span>
  <span class="p">}</span>
</code></pre></div>      </div>

      <p>重定向</p>

      <div class="language-nginx highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>  <span class="k">server</span> <span class="p">{</span>
    <span class="kn">listen</span> <span class="mi">80</span><span class="p">;</span>

    <span class="kn">server_name</span> <span class="s">admin.exmaple.com</span><span class="p">;</span>

    <span class="kn">return</span> <span class="mi">301</span> <span class="s">https://admin.exmaple.com</span><span class="nv">$request_uri</span><span class="p">;</span>
  <span class="p">}</span>
</code></pre></div>      </div>

      <p>Nginx的简单鉴权</p>

      <p><a href="https://docs.nginx.com/nginx/admin-guide/security-controls/configuring-http-basic-authentication/" target="_blank" rel="noopener noreferrer">Ref</a></p>

      <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>  <span class="nb">sudo </span>yum <span class="nb">install </span>httpd-tools
  <span class="nb">sudo </span>htpasswd <span class="nt">-c</span> /etc/nginx/.htpasswd user1
  <span class="nb">cat</span> /etc/nginx/.htpasswd

  Nginx 中的配置
  location /api <span class="o">{</span>
      auth_basic           <span class="s2">"admin area"</span><span class="p">;</span>
      auth_basic_user_file /etc/nginx/.htpasswd<span class="p">;</span>
  <span class="o">}</span>
</code></pre></div>      </div>

    </details>
  </li>
</ul>

<h3 id="基础设施">
<a class="anchor" href="#%E5%9F%BA%E7%A1%80%E8%AE%BE%E6%96%BD" aria-hidden="true"><span class="octicon octicon-link"></span></a>基础设施</h3>
<h4 id="gitlab">
<a class="anchor" href="#gitlab" aria-hidden="true"><span class="octicon octicon-link"></span></a>gitlab</h4>
<p><a href="https://github.com/jl-borges/docker-gitlab" target="_blank" rel="noopener noreferrer">Ref</a></p>

<ol>
  <li>注意，需要配置服务器的 swap, 见这里 <a href="https://docs.gitlab.com/omnibus/settings/memory_constrained_envs.html" target="_blank" rel="noopener noreferrer">SWAP</a>
</li>
  <li>
    <p>建议设置晚上定时重启对应 gitlab 服务, gitlab 经常有内存泄漏问题, <a href="https://crontab.guru/#0_*_*_*" target="_blank" rel="noopener noreferrer">定时重启</a> 是最简单粗暴的方式</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>   <span class="nb">sudo </span>crontab <span class="nt">-e</span>
   <span class="c"># 设置每天凌晨4点的时候重启 gitlab</span>
   0 4 <span class="k">*</span> <span class="k">*</span> <span class="k">*</span> docker restart gitlab_gitlab_1
</code></pre></div>    </div>
  </li>
</ol>

<p>需要更改的配置</p>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">TZ=Asia/Shanghai</span>
<span class="s">GITLAB_TIMEZONE=Asia/Shanghai</span>
<span class="s">GITLAB_HOST=gitlab.youDomain.com</span>

<span class="s">GITLAB_ROOT_PASSWORD=password!1234</span>
<span class="s">GITLAB_ROOT_EMAIL=youEmail</span>

<span class="s">SMTP_ENABLED=true</span>
<span class="s">SMTP_DOMAIN=youDomain.com</span>
<span class="s">SMTP_HOST=smtp.ym.163.com</span>
<span class="s">SMTP_PORT=25</span>
<span class="s">SMTP_USER=noreply@youDomain.com</span>
<span class="s">SMTP_PASS=youDomainPsw</span>
<span class="s">SMTP_STARTTLS=true</span>
<span class="s">SMTP_TLS=false</span>
<span class="s">SMTP_AUTHENTICATION=plain</span>
</code></pre></div></div>

<p>下面是 CI 的配置例子</p>

<hr data-content=" java ">

<ul>
  <li><a href="https://github.com/jl-borges/maker/blob/main/java/.gitlab-ci.yml" target="_blank" rel="noopener noreferrer">.gitlab-ci.yml</a></li>
  <li><a href="https://github.com/jl-borges/maker/blob/main/java/deploy.sh" target="_blank" rel="noopener noreferrer">deploy.sh</a></li>
  <li><a href="https://github.com/jl-borges/maker/blob/main/java/ci_settings.xml" target="_blank" rel="noopener noreferrer">ci_setting.yml</a></li>
  <li><a href="https://github.com/jl-borges/maker/blob/main/java/Dockerfile" target="_blank" rel="noopener noreferrer">Dockerfile</a></li>
</ul>

<hr data-content=" node ">

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">stages</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">prod-build</span>
  <span class="pi">-</span> <span class="s">prod-deploy</span>
<span class="na">variables</span><span class="pi">:</span>
  <span class="na">BUILD_MACHINE_IP</span><span class="pi">:</span> <span class="s">172.21.x.x</span>
<span class="na">cache</span><span class="pi">:</span>
  <span class="na">key</span><span class="pi">:</span> <span class="s">${CI_COMMIT_REF_SLUG}</span>
  <span class="na">paths</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">node_modules/</span>
<span class="na">prod-build</span><span class="pi">:</span>
  <span class="na">stage</span><span class="pi">:</span> <span class="s">prod-build</span>
  <span class="na">tags</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">adminBuild</span>
  <span class="na">script</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">npm install --registry=https://registry.npm.taobao.org</span>
    <span class="pi">-</span> <span class="s">npm run build:prod</span>
    <span class="pi">-</span> <span class="s">mkdir -p /var/www/site/admin_prod</span>
    <span class="pi">-</span> <span class="s">cp -rf $PWD/dist/** /var/www/site/admin_prod</span>
<span class="na">prod-deploy</span><span class="pi">:</span>
  <span class="na">tags</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">prod</span>
  <span class="na">stage</span><span class="pi">:</span> <span class="s">prod-deploy</span>
  <span class="na">when</span><span class="pi">:</span> <span class="s">manual</span>
  <span class="na">script</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">scp -Cr youName@$BUILD_MACHINE_IP:/var/www/site/admin_prod /var/www/site/</span>
</code></pre></div></div>

<h4 id="其他">
<a class="anchor" href="#%E5%85%B6%E4%BB%96" aria-hidden="true"><span class="octicon octicon-link"></span></a>其他</h4>

<ul>
  <li>
    <p><a href="https://github.com/jl-borges/maker/blob/main/maven/docker-compose.yml" target="_blank" rel="noopener noreferrer">Maven</a></p>

    <p>注: 密码需要到 /nexus-data/admin.password 里面去查看</p>
  </li>
  <li>
    <p><a href="https://github.com/jl-borges/docker-reviewboard" target="_blank" rel="noopener noreferrer">Reviewboard</a></p>

    <p>注: 这里不能调用 docker-compose down, 该部分会删除记录… 重启的话, 执行 docker-compose restart</p>
  </li>
  <li>
    <p><a href="https://github.com/jl-borges/spring-boot-admin" target="_blank" rel="noopener noreferrer">Spring boot admin</a></p>
  </li>
  <li>
    <p><a href="https://github.com/jl-borges/baota?organization=jl-borges&amp;organization=jl-borges" target="_blank" rel="noopener noreferrer">宝塔</a></p>
  </li>
  <li>
    <p><a href="https://github.com/jl-borges/netdata" target="_blank" rel="noopener noreferrer">Netdata</a></p>
  </li>
  <li>
    <p><a href="https://github.com/jl-borges/metabase" target="_blank" rel="noopener noreferrer">BI</a></p>
  </li>
</ul>

<h3 id="中间件">
<a class="anchor" href="#%E4%B8%AD%E9%97%B4%E4%BB%B6" aria-hidden="true"><span class="octicon octicon-link"></span></a>中间件</h3>
<ul>
  <li><a href="https://github.com/jl-borges/maker/blob/main/mysql/docker-compose.yml" target="_blank" rel="noopener noreferrer">MySQL</a></li>
  <li><a href="https://github.com/jl-borges/maker/blob/main/redis/docker-compose.yml" target="_blank" rel="noopener noreferrer">Redis</a></li>
  <li>
<a href="https://github.com/jl-borges/docker-elk" target="_blank" rel="noopener noreferrer">ELK</a>
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>  curl <span class="nt">-L</span> <span class="nt">-O</span> https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-7.12.1-x86_64.rpm
  <span class="nb">sudo </span>rpm <span class="nt">-vi</span> filebeat-7.12.1-x86_64.rpm
</code></pre></div>    </div>
  </li>
  <li>Kafak, TODO</li>
</ul>

<h3 id="业务系统">
<a class="anchor" href="#%E4%B8%9A%E5%8A%A1%E7%B3%BB%E7%BB%9F" aria-hidden="true"><span class="octicon octicon-link"></span></a>业务系统</h3>
<ul>
  <li>Java, see legacy</li>
  <li>Antd-React, see legacy</li>
</ul>

<h3 id="搭建系统路线">
<a class="anchor" href="#%E6%90%AD%E5%BB%BA%E7%B3%BB%E7%BB%9F%E8%B7%AF%E7%BA%BF" aria-hidden="true"><span class="octicon octicon-link"></span></a>搭建系统路线</h3>
<ol>
  <li>
    <p>域名购买, ssl 证书申请, 域名备案</p>
  </li>
  <li>
    <p>邮箱配置, 办公软件等</p>
  </li>
  <li>购买机器和服务
    <ul>
      <li>dev 机器, 4核8G 50G硬盘, 2M带宽</li>
      <li>qa 机器, 2核4G 50G硬盘, 2M带宽</li>
      <li>prod 机器, 2核4G 50G硬盘, 2M带宽</li>
      <li>ES 服务 2核4G</li>
      <li>MySQL 主库</li>
      <li>MySQL 从库</li>
      <li>短信服务</li>
      <li>七牛服务</li>
    </ul>
  </li>
  <li>基础服务搭建
    <ul>
      <li>gitlab, 代码仓库, 部署在 dev 机器上</li>
      <li>maven, java 基础库</li>
      <li>netdata, 服务器监控</li>
      <li>metabase, bi工具</li>
      <li>elk, 日志收集工具</li>
      <li>sba, java 日志收集</li>
      <li>redis 服务</li>
    </ul>
  </li>
  <li>基础代码部署和初次上线
    <ul>
      <li>利用基础包, 生成后端的基础代码</li>
      <li>利用 antd, 生成现成的 admin 代码</li>
      <li>nginx 配置</li>
      <li>gitlab-ci 配置</li>
    </ul>
  </li>
  <li>核心配置
    <ul>
      <li>包名称</li>
      <li>支付秘钥</li>
      <li>短信/七牛配置</li>
      <li>数据库/redis 配置等</li>
    </ul>
  </li>
  <li>测试和数据配置
    <ul>
      <li>核心接口整理</li>
      <li>配置后台数据</li>
    </ul>
  </li>
</ol>

</article>

<div id="comment"></div>
<script>
  gitalk.render('comment');
</script>



      </div>
    </main>

    
  </body>
</html>